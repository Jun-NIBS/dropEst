---
title: "10x Aml035 Post"
output:
  html_document:
    df_print: kable
    number_sections: yes
    theme: cerulean
    toc: yes
  html_notebook: default
---

```{r global_options, include=FALSE}
library(ggplot2)
library(ggsci)
library(ggpubr)
library(ggrastr)
library(dplyr)
library(parallel)
library(reshape2)

source("./Functions/PlotFuncs.R")
source("./Functions/Functions.R")

knitr::opts_chunk$set(fig.width=5, fig.height=3, echo=FALSE, warning=FALSE, message=FALSE)

theme_set(theme_base)
kPlotsFolder <- '~/Data/Plots/Paper/Review/UmiErrors/'
kDataPath <- '/d0-mendel/home/viktor_petukhov/Data/10x/aml035_post_transplant/est_10_20_umi_quality/'
```

```{r}
ErrorNumProb <- function(error.num, reads.num, error.prob, p.collisions) {
  if (error.num > reads.num)
    return(0)
  
  cell <- function(i) {
    dbinom(i, size=reads.num, prob=error.prob) * p.collisions[error.num + 1, i + 1]
  }
  return(sum(sapply(error.num:reads.num, cell)))
}

ErrorProbsGivenNumOfReadsLarge <- function(max.reads.num, error.prob, umi.num) {
  p.collisions <- FillDpMatrix(1, umi.num + 1, max.reads.num + 1)
  probs <- sapply(1:max.reads.num, function(r) sapply(0:umi.num, function(e) 
    ErrorNumProb(e, r, error.prob, p.collisions)))
  
  colnames(probs) <- paste(1:ncol(probs))
  rownames(probs) <- paste(0:(nrow(probs) - 1))
  return(probs)
}

EstimateReadsBetaBinomial <- function(reads.small, reads.large, error.prob) {
  llBetabinom <- function(theta) {
    -sum(emdbook::dbetabinom(reads.small, prob=error.prob, size=reads.large + reads.small, theta=theta, log=TRUE))
  }
  
  thetas.list <- seq(5, 100, 10)
  for (theta in thetas.list) {
    params <- try(suppressWarnings(as.list(bbmle::mle2(llBetabinom, start=list(theta=theta))@fullcoef)), silent=T)
    if (class(params) != 'try-error')
      break
  }
  
  if (class(params) == 'try-error') {
    params <- try(suppressWarnings(bbmle::mle2(llBetabinom, start=list(theta=20), method='Nelder-Mead')@fullcoef), silent=T)
  }
  
  if (class(params) == 'try-error') {
    stop("Unable to estimate distribution parameters: " + str(theta))
  }
  
  return(params$theta)
}

ReadsPerUmiDataset <- function(reads.per.umi.per.cb, max.umis.per.cb=4) { # TODO: merge it with TrainNBClassifier
  umis.per.gene <- sapply(reads.per.umi.per.cb, length)
  reads.large.all <- unlist(ExtractReadsPerUmi(reads.per.umi.per.cb[umis.per.gene == 1]))
  reads.small.all <- rep(0, length(reads.large.all))
  
  for (i in 2:max.umis.per.cb) {
    rpus <- ExtractReadsPerUmi(reads.per.umi.per.cb[umis.per.gene == i])
    adj.umis <- lapply(rpus, function(g) sapply(SubsetAdjacentUmis(names(g)), length))
    nn <- setNames(sapply(adj.umis, max), names(sapply(adj.umis, which.max)))
    
    selected.inds <- which(nn == i - 1)
    selected.inds <- selected.inds[sapply(adj.umis[selected.inds], which.max) == 
                                     sapply(rpus[selected.inds], which.max)]
    
    reads.small <- mapply(function(r, n) sum(r[names(r) != n]), rpus[selected.inds], names(selected.inds))
    reads.large <- mapply(function(r, n) r[[n]], rpus[selected.inds], names(selected.inds))
    
    reads.small.all <- c(reads.small.all, reads.small)
    reads.large.all <- c(reads.large.all, reads.large)
  }
  
  return(data.frame(Large=reads.large.all, Small=reads.small.all))
}
```

```{r}
# holder <- readRDS(paste0(kDataPath, '/aml035ost_transplant.rds'))
# reads_per_umi_per_cell <- holder$reads_per_umi_per_cell
# reads_per_umi_per_cell$reads_per_umi <- FilterNUmis(holder$reads_per_umi_per_cell$reads_per_umi)
# 
# saveRDS(reads_per_umi_per_cell, paste0(kDataPath, 'reads_per_umi_per_cell.rds'))

# reads_per_umi_per_cell <- readRDS(paste0(kDataPath, 'reads_per_umi_per_cell.rds'))
# length(reads_per_umi_per_cell$reads_per_umi)
```
```{r}
# reads_per_umi_per_cell$reads_per_umi <- reads_per_umi_per_cell$reads_per_umi[1:100000]
```

```{r}
raw <- readRDS(paste0(kDataPath, 'raw.rds'))
trimmed <- readRDS(paste0(kDataPath, 'trimmed_6.rds'))
```

# Reads per UMI
```{r}
sum_rpus_small <- sum(reads_small_all)
sum_rpus_large <- sum(reads_large_all)

read_error_prob <- sum_rpus_small / (sum_rpus_large + sum_rpus_small)
read_error_prob
```

```{r}
reads_per_umi_train <- ReadsPerUmiDataset(trimmed$reads.per.umi.per.cb)
theta <- EstimateReadsBetaBinomial(reads_per_umi_train$Small, reads_per_umi_train$Large, read_error_prob)
reads_num <- 3
ggplot() + 
  geom_histogram(aes(x=reads_small_all[(reads_large_all + reads_small_all) == reads_num], y=..count.. / sum(..count..), color='Observed')) +
  geom_bar(aes(x=0:10, y=emdbook::dbetabinom(0:10, size=reads_num, prob=read_error_prob, theta=theta), color='beta'), stat='identity', width=0.5, alpha=0.5)
```

```{r}
rpus_extracted <- ExtractReadsPerUmi(trimmed$reads.per.umi.per.cb, mc.cores=10)
reads_num <- max(rpus_extracted %>% sapply(max))
umi_num <- nchar(names(trimmed$umi.probabilities)[1]) * 3 - 1
probs_given_reads_large <- ErrorProbsGivenNumOfReadsLarge(reads_num, read_error_prob, umi_num)


rpu_distribution <- SmoothDistribution(unlist(rpus_extracted) - 1, 10, log.probs=F)
```

```{r}
classifier <- TrainNBClassifier(trimmed$reads.per.umi.per.cb, 50, trimmed$correction.info, trimmed$umi.probabilities)
classifier$RpU <- list(Distribution=log(rpu_distribution), NegDistParams=list(Theta=theta, Prob=read_error_prob), ErrNumRL=probs_given_reads_large)
```

```{r}
classifier_df <- data.frame(Base=names(trimmed$umi.probabilities)[1:10], Target='AAAAAA', Quality = 52, MinRpU=1, MaxRpU=25)
PredictNew(classifier, classifier_df)
```

```{r}
rpus_filt <- mclapply(trimmed$correction.info$rpus.with.inds, FilterUmisInGeneNew, trimmed$umi.probabilities, 
                      classifier, mc.cores=30)

rpus_filt <- lapply(trimmed$correction.info$rpus.with.inds[1:1000], FilterUmisInGeneNew, trimmed$umi.probabilities, 
                      classifier)

r0 <- FilterUmisInGeneNew(trimmed$correction.info$rpus.with.inds[trimmed$umis.per.gene == 50][[2]], trimmed$umi.probabilities, probs_given_reads_large, classifier)

trimmed$filt_cells$NB <- trimmed$collisions.info[sapply(rpus_filt, length)]
```

```{r}
ggs <- PlotTrimmedCorrections(trimmed, raw, 6, raster=F)
ggs$large
```

```{r}
ggs$small
```

```{r}
ggs <- PlotTrimmedCorrections(trimmed, raw, 6, raster=F)
ggs$large + theme_pdf()
```

```{r}
ggs$small + theme_pdf()
```

