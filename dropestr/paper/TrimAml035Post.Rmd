---
title: "10x Aml035 Post"
output:
  html_document:
    df_print: kable
    number_sections: yes
    theme: cerulean
    toc: yes
  html_notebook: default
---

```{r global_options, include=FALSE}
library(ggplot2)
library(ggsci)
library(ggpubr)
library(ggrastr)
library(dplyr)
library(parallel)
library(reshape2)

source("./Functions/PlotFuncs.R")
source("./Functions/Functions.R")

knitr::opts_chunk$set(fig.width=5, fig.height=3, echo=FALSE, warning=FALSE, message=FALSE)

theme_set(theme_base)
kPlotsFolder <- '~/Data/Plots/Paper/Review/UmiErrors/'
kDataPath <- '/d0-mendel/home/viktor_petukhov/Data/10x/aml035_post_transplant/'
```

```{r}
# holders <- mclapply(paste0(kDataPath, c('est_01_21_umi_quality/aml035ost_transplant.rds', 'est_01_21_10x_umi/aml035ost_transplant.rds')), readRDS, mc.cores=2) %>%
#   setNames(c('raw', '10x'))
# 
# reads_per_umi_per_cell <- holders$raw$reads_per_umi_per_cell
# reads_per_umi_per_cell$reads_per_umi <- FilterNUmis(reads_per_umi_per_cell$reads_per_umi)
# 
# saveRDS(reads_per_umi_per_cell, paste0(kDataPath, 'reads_per_umi_per_cell.rds'))

reads_per_umi_per_cell <- readRDS(paste0(kDataPath, 'reads_per_umi_per_cell.rds'))
# raw <- readRDS(paste0(kDataPath, 'raw.rds'))

length(reads_per_umi_per_cell$reads_per_umi)
```

# UMI errors
```{r}
# tr_cur <- TrimAndCorrect(reads_per_umi_per_cell, umi.trim.length=6, mc.cores.large=30, mc.cores.small=30, verbosity.level=1, prepare.only=T)
# classifier <- TrainNBClassifier(tr_cur$reads.per.umi.per.cb, distribution.smooth=50, umi.probabilities=tr_cur$umi.probabilities, mc.cores=10)
```

```{r}
# umi_probabilities_map <- new(CppMap, names(tr_cur$umi.probabilities), as.vector(tr_cur$umi.probabilities))
# # gp <- profvis::profvis(r0 <- lapply(tr_cur$reads.per.umi.per.cb[tr_cur$umis.per.gene > 1][1:1000], FilterUmisInGene, umi_probabilities_map, classifier,
# #        tr_cur$correction.info$dp.matrices, tr_cur$correction.info$neighb.prob.index, tr_cur$collisions.info))
# 
# r0 <- lapply(tr_cur$reads.per.umi.per.cb[tr_cur$umis.per.gene > 1][1:1000], FilterUmisInGene, umi_probabilities_map, classifier,
#        tr_cur$correction.info$dp.matrices, tr_cur$correction.info$neighb.prob.index, tr_cur$collisions.info)
```

```{r}
# r0 <- mclapply(tr_cur$reads.per.umi.per.cb[1:100000], FilterUmisInGene, umi_probabilities_map, classifier,
#                tr_cur$correction.info$dp.matrices, tr_cur$correction.info$neighb.prob.index,
#                tr_cur$collisions.info, mc.cores=30)
```

```{r}
# largest_gene <- tr_cur$reads.per.umi.per.cb[[which.max(tr_cur$umis.per.gene)]]
# r1 <- FilterUmisInGene(largest_gene, umi_probabilities_map, classifier, tr_cur$correction.info$dp.matrices, 
#                        tr_cur$correction.info$neighb.prob.index, tr_cur$collisions.info, verbose=T)
```

```{r}
trimmed <- lapply(6:9, function(i) TrimAndCorrect(reads_per_umi_per_cell, umi.trim.length=i, mc.cores.large=30, mc.cores.small=30, verbosity.level=1))
for (i in 1:length(trimmed)) {
  trimmed[[i]]$umis.per.gene.adj <- trimmed[[i]]$collisions.info[trimmed[[i]]$umis.per.gene]
}

raw <- list()

raw$umi_distribution <- GetUmisDistribution(reads_per_umi_per_cell$reads_per_umi, smooth = 10)
raw$umi_probabilities <- raw$umi_distribution / sum(raw$umi_distribution)

max_umi_per_gene <- sapply(reads_per_umi_per_cell$reads_per_umi, length) %>% max()
raw$collisions_info <- FillCollisionsAdjustmentInfo(raw$umi_probabilities, max_umi_per_gene)
raw$correction_info <- PrepareUmiCorrectionInfo(umi.probabilities=raw$umi_probabilities, raw$collisions_info[max_umi_per_gene])

raw$filt_umis_per_gene_simple <- CorrectUmiSequenceErrors(reads_per_umi_per_cell, raw$umi_probabilities, method='Classic',
                                                          correction.info=raw$correction_info, collisions.info=raw$collisions_info,
                                                          mc.cores=30, verbosity.level=2, return='umis')

raw$umis_per_gene <- sapply(reads_per_umi_per_cell$reads_per_umi, length)

saveRDS(raw, paste0(kDataPath, 'raw4_umi.rds'))
saveRDS(trimmed, paste0(kDataPath, 'trimmed4_umi.rds'))
```

```{r}
raw <- readRDS(paste0(kDataPath, 'raw4_umi.rds'))
trimmed <- readRDS(paste0(kDataPath, 'trimmed4_umi.rds'))
# raw <- readRDS(paste0(kDataPath, 'raw3.rds'))
# trimmed <- readRDS(paste0(kDataPath, 'trimmed3.rds'))
```

## Plots
## Supp. figure
```{r}
plots <- lapply(6:9, function(i) PlotTrimmedCorrections(trimmed[[i - 5]], raw, i, log=T, rast.width=4,
                                                        rast.height=4.5, rast.dpi=200, heights.ratio=c(2.5, 3)))
large_plots <- lapply(plots, `[[`, 'large') %>% lapply(`+`, annotation_logticks(sides='b'))
small_plots <- lapply(plots, `[[`, 'small')
```

```{r, fig.width=8, fig.height=9, warning=FALSE, message=FALSE}
title_theme <- theme(plot.title=element_text(size=12))
gp_large <- BuildPanel4(large_plots, xlabel="Corrected #UMIs without trimming", ylabel="Error on trimmed data, %", 
                        show.legend=T, labels=NULL, plot.theme=title_theme)
gp_small <- BuildPanel4(small_plots, xlabel="Corrected #UMIs without trimming", ylabel="Error on trimmed data, %", 
                        show.legend=F, labels=NULL, plot.theme=title_theme)
supp_fig_errors <- cowplot::plot_grid(gp_large, gp_small, nrow=2, labels=c('A', 'B'), rel_heights=c(5, 6))
supp_fig_errors
```

```{r}
pdf(paste0(kPlotsFolder, 'SuppFigTrimRast.pdf'), width=8, height=9)
print(supp_fig_errors)
dev.off()
```

## Main figure
```{r}
umis_per_gene <- as.data.frame(lapply(trimmed, `[[`, 'umis.per.gene'))
colnames(umis_per_gene) <- paste0(6:9)
errors <- cbind((umis_per_gene - raw$filt_umis_per_gene_simple) / raw$filt_umis_per_gene_simple, Real=raw$filt_umis_per_gene_simple)
errors <- melt(errors, id.vars='Real', variable.name='UmiLength', value.name='Error')
errors_sum <- errors %>% group_by(Real, UmiLength) %>% summarise(Error=mean(Error, trim=0.2))
```

```{r}
kPlotWidth <- 8
kPlotHeight <- 7
gp1 <- ggplot(errors_sum, aes(x=Real, y=Error, color=UmiLength)) +
  geom_point_rast(size=0.3, alpha=0.5, width=kPlotWidth / 2, height=kPlotHeight / 3) +
  geom_smooth() +
  scale_x_log10(expand=c(0.01, 0)) + annotation_logticks(sides='b') + ylim(-0.8, 0.75) +
  theme_pdf(legend.pos=c(0, 0)) +
  scale_color_npg() +
  guides(color=guide_legend(title='Length of trimmed UMI', ncol=4))
gp1
```

```{r}
fig_umi_length <- 6

raw$filt_reads_per_umi_simple <- CorrectUmiSequenceErrors(reads_per_umi_per_cell, raw$umi_probabilities, method='Classic',
                                                          correction.info=raw$correction_info, collisions.info=raw$collisions_info,
                                                          mc.cores=30, verbosity.level=2, return='reads')

trimmed_corrected_cells <- lapply(raw$filt_reads_per_umi_simple, TrimUmis, fig_umi_length)
```

```{r}
umis_per_gene_plt <- data.frame(none=sapply(trimmed_corrected_cells, length), real=raw$filt_umis_per_gene_simple)

umis_per_gene_plt$empirical <- trimmed[[fig_umi_length - 5]]$collisions.info[umis_per_gene_plt$none]
umis_per_gene_plt$uniform <- sapply(umis_per_gene_plt$none, AdjustGeneExpressionClassic, 4^fig_umi_length)
umis_per_gene_plt_df <- melt(as.data.frame(umis_per_gene_plt), id.vars='real', variable.name='Adjustment', value.name='value')

umis_per_gene_plt_df <- umis_per_gene_plt_df %>% group_by(Adjustment, real) %>% summarize(value=mean(value, 0.2))

gp2 <- ggplot(umis_per_gene_plt_df, aes(x=real, y=100 * (value - real) / real, col=Adjustment)) +
  geom_point_rast(size=0.3, alpha=0.3, width=kPlotWidth / 2, height=kPlotHeight / 3) +
  geom_smooth() +
  scale_x_log10(expand=c(0.01, 0)) + annotation_logticks(sides='b') +
  scale_y_continuous(expand=c(0, 0), limits=c(-61, 11)) +
  scale_color_nejm() +
  labs(x='Corrected #molecules without trimming', y='Error, %') +
  guides(color = guide_legend(title='Collisions adjustment', ncol=3)) +
  theme_pdf(legend.pos=c(0, 0))

gp2
```

```{r}
# correction_colors <- c(`CellRanger`="#2222F2", Bayesian="#017A5A", cluster="#9B3BB8", `cluster-neq`="#E69F00", directional="#BD5500", `no correction`='#757575')
# color_scale <- scale_color_manual(name='Correction', values=alpha(correction_colors, 0.7))
```

```{r}
fig_umi_length <- 7
corrected_data <- as_tibble(trimmed[[fig_umi_length - 5]]$filt_cells)
colnames(corrected_data) <- c('Bayesian', 'cluster', 'cluster-neq', 'directional')
corrected_data$`no correction` <- trimmed[[fig_umi_length - 5]]$umis.per.gene
corrected_data$real <- raw$filt_umis_per_gene_simple

plot_df <- melt(corrected_data, id.vars='real', variable.name='Correction') %>%
  group_by(Correction, real) %>% summarize(value=median(value))

gp3 <- ggplot(plot_df, aes(x=real, y=100 * (value - real) / real, color=Correction)) +
  geom_point_rast(size=0.3, alpha=0.3, width=kPlotWidth / 2, height=kPlotHeight / 3) +
  geom_smooth() +
  scale_x_log10(expand=c(0.01, 0)) + annotation_logticks(sides='b') +
  scale_y_continuous(limits=c(-101, 51), expand=c(0, 0)) +
  # scale_color_manual(values=correction_colors[2:length(correction_colors)]) +
  guides(color=guide_legend(ncol=3)) + theme_pdf(legend.pos=c(0, 0))

gp3
```

```{r}
aml035_plots <- list(gp1=gp1, gp2=gp2, gp3=gp3)
saveRDS(aml035_plots, paste0(kDataPath, '/gg_plots.rds'))
```

```{r}
aml035_plots <- readRDS(paste0(kDataPath, '/gg_plots.rds'))
bmmc_plots_data <- readRDS('~/tmp_r_exchange/bmmc_umi_fig_part2.rds')
```

```{r, fig.width=4, fig.height=7}
scale_color_short <- scale_color_manual(values=alpha(bmmc_plots_data$correction_colors, 0.7) %>% setNames(names(bmmc_plots_data$correction_colors)))
figure_trim <- cowplot::plot_grid(aml035_plots$gp1 + theme_pdf() + ylab('Error, %') + rremove("xlab") + theme(plot.margin=margin(b=2, unit='pt')),
                         aml035_plots$gp2 + theme_pdf() + rremove("xlab") + theme(plot.margin=margin(b=2, unit='pt')),
                         aml035_plots$gp3 + theme_pdf() + ylab('Error, %') +
                           scale_color_short +
                           guides(color=guide_legend(title='Correction (see Figure D)', label.theme=element_blank(), ncol=5, reverse=T)) +
                           rremove("xlab") + theme(plot.margin=margin()),
                         ncol=1, nrow=3, labels = c("A", "B", "C"), align='v')

figure_trim_ann <- annotate_figure(figure_trim + theme(plot.margin=margin(t=10, l=0, unit='pt')),
                                   bottom=text_grob("Gene expression magnitude (#molecules)", size=14))

figure_trim_ann
```

```{r, fig.width=8, fig.height=7}
fig_full <- cowplot::plot_grid(figure_trim_ann + theme(plot.margin=margin()), 
                               bmmc_plots_data$gg_fig + theme(plot.margin=margin()), ncol=2)
fig_full_ann <- annotate_figure(fig_full, fig.lab="Figure 2", fig.lab.pos="top.right")
fig_full
```

```{r}
pdf(paste0(kPlotsFolder, '/Figure.pdf'), width=8, height=7)
print(fig_full_ann)
dev.off()
```
