---
title: "10x Aml035 Post"
output:
  html_document:
    df_print: kable
    number_sections: yes
    theme: cerulean
    toc: yes
  html_notebook: default
---

```{r}
source("./Functions/PlotFuncs.R")
source("./Functions/Functions.R")
```

```{r global_options, include=FALSE}
library(ggplot2)
library(ggsci)
library(ggpubr)
library(dplyr)
library(parallel)

knitr::opts_chunk$set(fig.width=5, fig.height=3, echo=FALSE, warning=FALSE, message=FALSE)

theme_set(theme_bw(base_size=14, base_family='Helvetica') + theme(plot.title = element_text(hjust = 0.5)))
```

```{r}
holder <- readRDS('/d0-mendel/home/viktor_petukhov/Data/10x/aml035_post_transplant/est_10_20_umi_quality/aml035ost_transplant.rds')
reads_per_umi_per_cell <- holder$reads_per_umi_per_cell
reads_per_umi_per_cell$reads_per_umi <- FilterNUmis(holder$reads_per_umi_per_cell$reads_per_umi)
```

<!-- Simple filtration of the raw data -->
```{r}
raw <- list()

raw$umi_distribution <- GetUmisDistribution(reads_per_umi_per_cell$reads_per_umi, smooth = 10)
raw$correction_info <- PrepareUmiCorrectionInfoWrapper(reads_per_umi_per_cell$reads_per_umi, umi.probabilities=raw$umi_distribution / sum(raw$umi_distribution),
                                                       method='Classic', verbosity.level=2, max.umi.per.gene=NULL, probability.quants.num=NULL)

max_umi_per_gene <- max(sapply(reads_per_umi_per_cell$reads_per_umi, length))
collisions_info <- FillCollisionsAdjustmentInfo(raw$umi_distribution / sum(raw$umi_distribution), max_umi_per_gene)

raw$filt_umis_per_gene_simple <- CorrectUmiSequenceErrors(reads_per_umi_per_cell, raw$umi_distribution, method='Classic',
                                                          correction.info=raw$correction_info, collisions.info=collisions_info,
                                                          mc.cores=30, verbosity.level=2, return='umis')

trimmed <- lapply(6:9, function(i) TrimAndCorrect(reads_per_umi_per_cell, umi.trim.length=i, mc.cores.large=30, mc.cores.small=15, verbosity.level=1))
```

## Plots
```{r, fig.width=10, fig.height=5, warning=FALSE, message=FALSE}
for (i in 6:9) {
  print(PlotTrimmedCorrections(trimmed[[i - 5]], raw, i))
}
```

